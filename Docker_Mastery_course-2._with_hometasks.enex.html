<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307881 (en-US, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="4027"/>

<div>
<span><div><div>The second one</div><div><br/></div><div><br/></div><div>Section 6 lecture 51</div><div><br/></div><div style="margin: 0mm 0mm 2.81mm; text-indent: 0mm;"><span style="line-height: 108%;"><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image.png" type="image/png" data-filename="Image.png" width="635"/></span></div><div style="margin: 0mm 0mm 2.81mm; text-indent: 0mm;"><br/></div><div style="margin: 0mm 0mm 2.81mm; text-indent: 0mm;"><span style="line-height: 108%;">52</span></div><div style="margin: 0mm 0mm 2.81mm; text-indent: 0mm;"><span style="line-height: 108%;"><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [1].png" type="image/png" data-filename="Image.png" width="639"/></span></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>df</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>version: '2'</div><div><br/></div><div>services:</div><div><br/></div><div>  drupal:</div><div>    image: drupal:8-apache</div><div>    environment:</div><div>      DB_host: postgres</div><div>      #DB_DATABASE: postgres</div><div>      #POSTGRES_DB=postgres</div><div>    ports:</div><div>      - &quot;8082:80&quot;</div><div>    volumes:</div><div>      - /var/www/html/modules</div><div>      - /var/www/html/profiles</div><div>      - /var/www/html/themes</div><div>      # this takes advantage of the feature in Docker that a new anonymous</div><div>      # volume (which is what we're creating here) will be initialized with the</div><div>      # existing content of the image at the same location</div><div>      - /var/www/html/sites</div><div>    restart: always</div><div><br/></div><div>  postgres:</div><div>    image: postgres:10</div><div>    environment:</div><div>      POSTGRES_PASSWORD: example      </div><div>    restart: always</div></div><div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>sd</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>Стоит попробовать такой еще совет по именованным волюмам в версии 3 компостера:</div><div><a href="https://github.com/docker/compose/issues/4675">https://github.com/docker/compose/issues/4675</a></div><div><br/></div><div>version: '3'services:</div><div>worker:</div><div>...</div><div>volumes:</div><div>- common_code:/application/path</div><div>different-worker:</div><div>...</div><div>volumes:</div><div>- common_code:/different/application/pathvolumes:</div><div>- type: bind</div><div>name: common_code</div><div>source: /local/path</div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">При первомстарте в Dockerfile была ошибка - отсутствовал &amp;&amp; на одной из строк:</span></div><div>vdanev@ora-vsrv:~/docker/udemy-docker-mastery/compose-assignment-2$ docker-compose up</div><div>Creating network &quot;compose-assignment-2_default&quot; with the default driver</div><div>Building drupal</div><div>Step 1/7 : FROM drupal:8.2</div><div>8.2: Pulling from library/drupal</div><div>ef0380f84d05: Pull complete</div><div>...</div><div>Digest: sha256:f2dc3f325da9c9e017f5e2ee0e22a72781cdded21955e533c412d35e09304f8c</div><div>Status: Downloaded newer image for drupal:8.2</div><div>---&gt; 68b9d32702ee</div><div>Step 2/7 : ENV http_proxy &quot;<a href="http://10.1.32.100:8081/">http://10.1.32.100:8081</a>&quot;</div><div>---&gt; Running in 67f2aa30c641</div><div>Removing intermediate container 67f2aa30c641</div><div>---&gt; 4e2221fe2081</div><div>Step 3/7 : ENV https_proxy &quot;<a href="http://10.1.32.100:8081/">http://10.1.32.100:8081</a>&quot;</div><div>---&gt; Running in 49bc9f40c420</div><div>Removing intermediate container 49bc9f40c420</div><div>---&gt; 58fbc8ea14cd</div><div>Step 4/7 : RUN apt-get update &amp;&amp; apt-get install -y git  rm -rf /var/lib/apt/lists/*</div><div>---&gt; Running in 49ae62944fb3</div><div><br/></div><div>Get:1 <a href="http://security.debian.org/">http://security.debian.org</a> jessie/updates InRelease [44.9 kB]</div><div>Ign <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie InRelease</div><div>Get:2 <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie-updates InRelease [145 kB]</div><div>Get:3 <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie Release.gpg [2420 B]</div><div>Get:4 <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie Release [148 kB]</div><div>Get:5 <a href="http://security.debian.org/">http://security.debian.org</a> jessie/updates/main amd64 Packages [717 kB]</div><div>Get:6 <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie-updates/main amd64 Packages [23.0 kB]</div><div>Get:7 <a href="http://deb.debian.org/">http://deb.debian.org</a> jessie/main amd64 Packages [9098 kB]</div><div>Fetched 10.2 MB in 30s (332 kB/s)</div><div>Reading package lists...</div><div>E: Command line option 'r' [from -rf] is not known.</div><div>ERROR: Service 'drupal' failed to build: The command '/bin/sh -c apt-get update &amp;&amp; apt-get install -y git  rm -rf /var/lib/apt/lists/*' returned a non-zero code: 100</div><div>vdanev@ora-vsrv:~/docker/udemy-docker-mastery/compose-assignment-2$</div><div><br/></div><div><span style="font-weight: bold;">При втором запуске другая ошибка:</span></div><div>unning in 6ebbf2ba7ca6</div><div>Removing intermediate container 6ebbf2ba7ca6</div><div>---&gt; e24c89813934</div><div>Step 6/7 : RUN git clone --branch 8.x-3.x --single-branch --depth 1 <a href="https://git.drupal.org/project/bootstrap.git">https://git.drupal.org/project/bootstrap.git</a> &amp;&amp; chown -R www-data:www-data bootstrap</div><div>ERROR: Service 'drupal' failed to build: device or resource busy</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">После выполнения команд:</span></div><div>danev@ora-vsrv:~/docker/udemy-docker-mastery/compose-assignment-2$ docker-compose down --rmi local</div><div>Removing network compose-assignment-2_default</div><div>vdanev@ora-vsrv:~/docker/udemy-docker-mastery/compose-assignment-2$ docker-compose down --rmi all</div><div>Removing network compose-assignment-2_default</div><div>WARNING: Network compose-assignment-2_default not found.</div><div>Removing image custom-drupal</div><div>ERROR: Failed to remove image for service drupal: 404 Client Error: Not Found (&quot;No such image: custom-drupal:latest&quot;)</div><div>Removing image postgres:10</div><div><br/></div><div><span style="font-weight: bold;">С третьей попытки запустилось:</span></div><div>vdanev@ora-vsrv:~/docker/udemy-docker-mastery/compose-assignment-2$ docker-compose up</div><div>Creating network &quot;compose-assignment-2_default&quot; with the default driver</div><div>..</div><div>postgres_1_f975eb1afc57 | 2018-11-06 18:03:07.401 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432</div><div>postgres_1_f975eb1afc57 | 2018-11-06 18:03:07.401 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432</div><div>postgres_1_f975eb1afc57 | 2018-11-06 18:03:07.421 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</div><div>postgres_1_f975eb1afc57 | 2018-11-06 18:03:07.454 UTC [52] LOG:  database system was shut down at 2018-11-06 18:03:07 UTC</div><div>postgres_1_f975eb1afc57 | 2018-11-06 18:03:07.465 UTC [1] LOG:  database system is ready to accept connections</div><div>.</div><div><br/></div><div>Ссылка <a href="http://127.0.0.1:8082/core/install.php">http://127.0.0.1:8082/core/install.php</a> работает</div><div><br/></div><div>т.е.</div><div>Dockerfile</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>FROM drupal:8.2</div><div><br/></div><div><br/></div><div>ENV http_proxy &quot;http://10.1.32.100:8081&quot;</div><div>ENV https_proxy &quot;http://10.1.32.100:8081&quot;</div><div><br/></div><div>RUN apt-get update &amp;&amp; apt-get install -y git \</div><div>&amp;&amp; rm -rf /var/lib/apt/lists/*</div><div><br/></div><div>WORKDIR /var/www/html/themes</div><div><br/></div><div>RUN git clone --branch 8.x-3.x --single-branch --depth 1 https://git.drupal.org/project/bootstrap.git \</div><div>&amp;&amp; chown -R www-data:www-data bootstrap</div><div><br/></div><div>WORKDIR /var/www/html</div></div><div><br/></div><div>и</div><div><br/></div><div>docker-compose.yml</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>version: &quot;3&quot;</div><div><br/></div><div>services:</div><div><br/></div><div>  drupal:</div><div>    build:</div><div>      context: .</div><div>      dockerfile: Dockerfile</div><div>    image: custom-drupal</div><div>    environment:</div><div>      DB_host: postgres</div><div>    ports:</div><div>      - &quot;8082:80&quot;</div><div>    volumes:</div><div>      - /var/www/html/modules</div><div>      - /var/www/html/profiles</div><div>      - /var/www/html/themes</div><div>      - /var/www/html/sites</div><div>      - ./drupal-data:/var/lib/postgresql/data</div><div>    restart: always</div><div><br/></div><div>  postgres:</div><div>    image: postgres:10</div><div>    environment:</div><div>      POSTGRES_PASSWORD: example      </div><div>    restart: always</div></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div>У меня были ошибки с базой, поэтому я удалил все (--rmi all -v) и взял такие конфиги:</div><div><br/></div><div><span style="font-weight: bold;">docker-compose.yml</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>version: '2'</div><div><br/></div><div>services:</div><div><br/></div><div>  drupal:</div><div>    image: custom-drupal</div><div>    build: .</div><div>    ports:</div><div>      - &quot;8082:80&quot;</div><div>    volumes:</div><div>      - drupal-modules:/var/www/html/modules</div><div>      - drupal-profiles:/var/www/html/profiles</div><div>      - drupal-sites:/var/www/html/themes</div><div>      - drupal-themes:/var/www/html/sites</div><div>      </div><div><br/></div><div>  postgres:</div><div>    image: postgres:9.6</div><div>    environment:</div><div>      - POSTGRES_PASSWORD=mypassword  </div><div>    volumes:</div><div>      - drupal-data:/var/lib/postgresql/data</div><div><br/></div><div>      </div><div>volumes:</div><div>   drupal-data:</div><div>   drupal-modules:</div><div>   drupal-profiles:</div><div>   drupal-sites:</div><div>   drupal-themes:</div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Dockerfile</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>FROM drupal:8.2</div><div><br/></div><div><br/></div><div>ENV http_proxy &quot;http://10.1.32.100:8081&quot;</div><div>ENV https_proxy &quot;http://10.1.32.100:8081&quot;</div><div><br/></div><div>RUN apt-get update &amp;&amp; apt-get install -y git \</div><div>    &amp;&amp; rm -rf /var/lib/apt/lists/*</div><div><br/></div><div>WORKDIR /var/www/html/themes</div><div><br/></div><div>RUN git clone --branch 8.x-3.x --single-branch --depth 1 https://git.drupal.org/project/bootstrap.git \</div><div>    &amp;&amp; chown -R www-data:www-data bootstrap</div><div><br/></div><div>WORKDIR /var/www/html</div></div><div><br/></div><div>И запустил все это добро.</div><div>Прошел установку друпала:</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>1</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div>sd</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>root@node1:/tmp# <span style="font-weight: bold;">docker-machine create node1-1</span></div><div>Creating CA: /root/.docker/machine/certs/ca.pem</div><div>Creating client certificate: /root/.docker/machine/certs/cert.pem</div><div>Running pre-create checks...</div><div>(node1-1) Image cache directory does not exist, creating it at /root/.docker/machine/cache...</div><div>(node1-1) No default Boot2Docker ISO found locally, downloading the latest release...</div><div>(node1-1) Default Boot2Docker ISO is out-of-date, downloading the latest release...</div><div>(node1-1) Latest release for <a href="http://github.com/boot2docker/boot2docker">github.com/boot2docker/boot2docker</a> is v18.09.0</div><div>(node1-1) Downloading /root/.docker/machine/cache/boot2docker.iso from <a href="https://github.com/boot2docker/boot2docker/releases/download/v18.09.0/boot2docker.iso">https://github.com/boot2docker/boot2docker/releases/download/v18.09.0/boot2docker.iso</a>...</div><div>(node1-1) 0%....10%....20%....30%....40%....50%....60%....70%....80%....90%....100%</div><div>(node1-1) Copying /root/.docker/machine/cache/boot2docker.iso to /root/.docker/machine/machines/node1-1/boot2docker.iso...</div><div>(node1-1) Creating VirtualBox VM...</div><div>(node1-1) Creating SSH key...</div><div>(node1-1) Starting the VM...</div><div>(node1-1) Check network to re-create if needed...</div><div>(node1-1) Found a new host-only adapter: &quot;vboxnet0&quot;</div><div>(node1-1) Waiting for an IP...</div><div>Waiting for machine to be running, this may take a few minutes...</div><div>Detecting operating system of created instance...</div><div>Waiting for SSH to be available...</div><div>Detecting the provisioner...</div><div>Provisioning with boot2docker...</div><div>Copying certs to the local machine directory...</div><div>Copying certs to the remote machine...</div><div>Setting Docker configuration on the remote daemon...</div><div>Checking connection to Docker...</div><div>Docker is up and running!</div><div>To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env node1-1</div><div><br/></div><div>root@node1:/tmp# <span style="font-weight: bold;">docker-machine env node1-1</span></div><div>export DOCKER_TLS_VERIFY=&quot;1&quot;</div><div>export DOCKER_HOST=&quot;<a href="tcp://192.168.99.100:2376/">tcp://192.168.99.100:2376</a>&quot;</div><div>export DOCKER_CERT_PATH=&quot;/root/.docker/machine/machines/node1-1&quot;</div><div>export DOCKER_MACHINE_NAME=&quot;node1-1&quot;</div><div># Run this command to configure your shell:</div><div># eval $(docker-machine env node1-1)</div><div>root@node1:/tmp#</div><div><br/></div><div>root@node1:/tmp# <span style="font-weight: bold;">docker-machine ssh node1-1</span></div><div>   ( '&gt;')</div><div>  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.</div><div>(/-_--_-\)           <a href="http://www.tinycorelinux.net/">www.tinycorelinux.net</a></div><div><br/></div><div>docker@node1-1:~$ exit</div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker swarm init --advertise-addr 104.248.27.25</span></div><div>Error response from daemon: This node is already part of a swarm. Use &quot;docker swarm leave&quot; to leave this swarm and join another one.</div><div>root@node1:~# docker swarm leave --help</div><div><br/></div><div>Usage:  docker swarm leave [OPTIONS]</div><div><br/></div><div>Leave the swarm</div><div><br/></div><div>Options:</div><div>  -f, --force   Force this node to leave the swarm, ignoring warnings</div><div>root@node1:~# docker swarm leave</div><div>Error response from daemon: You are attempting to leave the swarm on a node that is participating as a manager. Removing the last manager erases all current state of the swarm. Use `--force` to ignore this message.</div><div>root@node1:~# docker swarm leave --force</div><div>Node left the swarm.</div><div>root@node1:~#</div><div>root@node1:~# <span style="font-weight: bold;">docker swarm init --advertise-addr 104.248.27.25</span></div><div>Swarm initialized: current node (5rhn6ymx9wjzub9k6fsfyqb7l) is now a manager.</div><div><br/></div><div>To add a worker to this swarm, run the following command:</div><div><br/></div><div>    docker swarm join --token SWMTKN-1-5trev7p602xl7cvi1fi4z1vccsup06tne7q024kxtpi6dluw1s-c565nxr5ns492tysk4og5uli0 104.248.27.25:2377</div><div><br/></div><div>To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.</div><div><br/></div><div><br/></div><h1>How to Configure the Linux Firewall for Docker Swarm on Ubuntu 16.04</h1><div><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-linux-firewall-for-docker-swarm-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-configure-the-linux-firewall-for-docker-swarm-on-ubuntu-16-04</a></div><div><br/></div><div>Execute the following commands on the nodes that will function as Swarm managers:</div><div>ufw allow 2376/tcp &amp;&amp; ufw allow 2377/tcp &amp;&amp; ufw allow 7946/tcp &amp;&amp; ufw allow 7946/udp &amp;&amp; ufw allow 4789/udp</div><div><br/></div><div><span style="font-weight: bold;">Then on each node that will function as a worker, execute the following commands:</span></div><div>ufw allow 2376/tcp &amp;&amp; ufw allow 7946/tcp &amp;&amp; ufw allow 7946/udp &amp;&amp; ufw allow 4789/udp</div><div>systemctl restart docker</div><div><br/></div><div>root@node2:~#  <span style="font-weight: bold;">docker swarm join --token SWMTKN-1-5trev7p602xl7cvi1fi4z1vccsup06tne7q024kxtpi6dluw1s-c565nxr5ns492tysk4og5uli0 104.248.27.25:2377</span></div><div>This node joined a swarm as a worker.</div><div><br/></div><div>root@node3:~# docker swarm leave</div><div>Node left the swarm.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;"> docker swarm join --token SWMTKN-1-5trev7p602xl7cvi1fi4z1vccsup06tne7q024kxtpi6dluw1s-c565nxr5ns492tysk4og5uli0 104.248.27.25:2377</span></div><div>This node joined a swarm as a worker.</div><div><br/></div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker node ls</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</div><div>5rhn6ymx9wjzub9k6fsfyqb7l *   node1               Ready               Active              Leader              18.06.1-ce</div><div>3fphlbf06wrcopll89qz5dzsd     node2               Ready               Active                                  18.06.1-ce</div><div>kowqlk42kyukt7bc92dyjp0dy     node3               Ready               Active                                  18.06.1-ce</div></div><div><br/></div><div>root@node1:/tmp# <span style="font-weight: bold;">docker swarm join-token manager</span></div><div>To add a manager to this swarm, run the following command:</div><div><br/></div><div>    docker swarm join --token SWMTKN-1-5trev7p602xl7cvi1fi4z1vccsup06tne7q024kxtpi6dluw1s-4o771iddnfs0t0pjn2veo4rfo 104.248.27.25:2377</div><div><br/></div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker swarm join-token worker</span></div><div>To add a worker to this swarm, run the following command:</div><div><br/></div><div>    docker swarm join --token SWMTKN-1-5trev7p602xl7cvi1fi4z1vccsup06tne7q024kxtpi6dluw1s-c565nxr5ns492tysk4og5uli0 104.248.19.195:2377</div><div><br/></div><div><br/></div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker node ls</span></div><div>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</div><div>5rhn6ymx9wjzub9k6fsfyqb7l     node1               Ready               Active              Leader              18.06.1-ce</div><div>3fphlbf06wrcopll89qz5dzsd     node2               Ready               Active              Reachable           18.06.1-ce</div><div>kowqlk42kyukt7bc92dyjp0dy     node3               Down                Active                                  18.06.1-ce</div><div>ya42dm3ks8vrlroxwz5xwbbpg *   node3               Ready               Active              Reachable           18.06.1-ce</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker service create --replicas 3 alpine ping 8.8.8.8</span></div><div>8z3iu0fuwue6gnlbfv6uw48r2</div><div>overall progress: 3 out of 3 tasks</div><div>1/3: running   [==================================================&gt;]</div><div>2/3: running   [==================================================&gt;]</div><div>3/3: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</div><div>8z3iu0fuwue6        sleepy_ptolemy      replicated          3/3                 alpine:latest</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker node ps</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</div><div>xj1p367zr2bg        sleepy_ptolemy.1    alpine:latest       node3               Running             Running 26 seconds ago</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker node ps node2</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</div><div>kafp4kzfu1yb        sleepy_ptolemy.3    alpine:latest       node2               Running             Running 43 seconds ago</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker service ps sleepy_ptolemy</span></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS</div><div>xj1p367zr2bg        sleepy_ptolemy.1    alpine:latest       node3               Running             Running about a minute ago                     </div><div>cwrrctup39kn        sleepy_ptolemy.2    alpine:latest       node1               Running             Running about a minute ago                     </div><div>kafp4kzfu1yb        sleepy_ptolemy.3    alpine:latest       node2               Running             Running about a minute ago    </div></div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [13].png" type="image/png" data-filename="Image.png"/></div></div><div>root@node1:~# <span style="font-weight: bold;">docker network create --driver overlay mydrupal</span></div><div>q56148b4mqdzikj1ol8i4w6hr</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name psql --network mydrupal -e POSTGRES_PASSWORD=mypass postgres</span></div><div>f25xqfnzzpacp5j6s2pz1y6x0</div><div>overall progress: 1 out of 1 tasks</div><div>1/1: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</div><div>f25xqfnzzpac        psql                replicated          1/1                 postgres:latest</div><div>8z3iu0fuwue6        sleepy_ptolemy      replicated          3/3                 alpine:latest</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker network ls</span></div><div>NETWORK ID          NAME                DRIVER              SCOPE</div><div>47d185017ae1        bridge              bridge              local</div><div>69d6fe0b3dc3        docker_gwbridge     bridge              local</div><div>fa66ed36c6c5        host                host                local</div><div>jdkr9aju5urj        ingress             overlay             swarm</div><div>q56148b4mqdz        mydrupal            overlay             swarm</div><div>2364c9e63d9f        none                null                local</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service ps psql</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</div><div>f9j7jo3zn039        psql.1              postgres:latest     node1               Running             Running 47 seconds ago</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker container logs psql.1.f9j7jo3zn039xh7iwv0d7ook7</span></div><div>The files belonging to this database system will be owned by user &quot;postgres&quot;.</div><div>This user must also own the server process.</div><div>...</div><div><br/></div><div>PostgreSQL init process complete; ready for start up.</div><div><br/></div><div>2018-11-09 13:51:43.917 UTC [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432</div><div>2018-11-09 13:51:43.918 UTC [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432</div><div>2018-11-09 13:51:43.924 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;</div><div>2018-11-09 13:51:43.945 UTC [48] LOG:  database system was shut down at 2018-11-09 13:51:43 UTC</div><div>2018-11-09 13:51:43.957 UTC [1] LOG:  database system is ready to accept connections</div><div><br/></div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name drupal --network mydrupal -p 80:80 drupal</span></div><div>yjcvs7tyj5cfyf4axkq5u6drz</div><div>overall progress: 1 out of 1 tasks</div><div>1/1: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</div><div>yjcvs7tyj5cf        drupal              replicated          1/1                 drupal:latest       *:80-&gt;80/tcp</div><div>f25xqfnzzpac        psql                replicated          1/1                 postgres:latest</div><div>8z3iu0fuwue6        sleepy_ptolemy      replicated          3/3                 alpine:latest</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">watch docker service ls</span></div><div>Every 2.0s: docker service ls                                                                                       node1: Fri Nov  9 13:59:41 2018</div><div><br/></div><div>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</div><div>yjcvs7tyj5cf        drupal              replicated          1/1                 drupal:latest       *:80-&gt;80/tcp</div><div>f25xqfnzzpac        psql                replicated          1/1                 postgres:latest</div><div>8z3iu0fuwue6        sleepy_ptolemy      replicated          3/3                 alpine:latest</div><div><br/></div><div><br/></div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name search --replicas 3 -p 9200:9200 elasticsearch:2</span></div><div>80cp2ce2p5xo028tae14wsu2e</div><div>overall progress: 2 out of 3 tasks</div><div>1/3: preparing [=================================&gt;                 ]</div><div>2/3: running   [==================================================&gt;]</div><div>3/3: running   [==================================================&gt;]</div><div><br/></div><div><br/></div><div>^COperation continuing in background.</div><div>Use `docker service ps 80cp2ce2p5xo028tae14wsu2e` to check progress.</div><div>root@node1:~#</div><div>root@node1:~# <span style="font-weight: bold;">docker service ps search</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE              ERROR               PORTS</div><div>ri9h0hjat1rk        search.1            elasticsearch:2     node1               Running             Running 19 minutes ago</div><div>yy93s93wnv9z        search.2            elasticsearch:2     node2               Running             Running 18 minutes ago</div><div>2z9b9wodudim        search.3            elasticsearch:2     node3               Running             Preparing 21 minutes ago</div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div>Вот что я сделал самостоятельно на ассесмент:</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#create two overlay networks</div><div>docker network create --driver overlay backend</div><div>docker network create --driver overlay frontend</div><div><br/></div><div>#create vote service</div><div>docker service create --name vote --network frontend --replicas 2 -p 80:80 dockersamples/examplevotingapp_vote:before</div><div>#redis</div><div>docker service create --name redis --network frontend redis:3.2</div><div>#worker</div><div>docker service create --name worker --network frontend --network backend dockersamples/examplevotingapp_worker</div><div>#db</div><div>docker service create --name db --network backend -e POSTGRES_PASSWORD=mypass --mount type=volume,source=db-data,target=/var/lib/postgresql/data postgres:9.4</div><div>#result</div><div>docker service create --name result --network backend  -p 5001:80 dockersamples/examplevotingapp_result:before</div></div><div><br/></div><div>Результат выполнения:</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</div><div>80cp2ce2p5xo        search              replicated          3/3                 elasticsearch:2     *:9200-&gt;9200/tcp</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker network create --driver overlay backend</span></div><div>48v8tslms4v001peiryqwf41f</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker network create --driver overlay frontend</span></div><div>77uzpz8eyptykvxyimkbpiuz2</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name vote --network frontend --replicas 2 -p 80:80 dockersamples/examplevotingapp_vote:before</span></div><div>nixnml5rtecs6bpyzlq3t01vz</div><div>overall progress: 2 out of 2 tasks</div><div>1/2: running   [==================================================&gt;]</div><div>2/2: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name redis --network frontend redis:3.2</span></div><div>m1p0xjgxjsspncvlv87yquc3u</div><div>overall progress: 1 out of 1 tasks</div><div>1/1: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name worker --network frontend --network backend dockersamples/examplevotingapp_worker</span></div><div>p1evkio5gq1apjn0iywno7drb</div><div>overall progress: 0 out of 1 tasks</div><div>overall progress: 0 out of 1 tasks</div><div>1/1: preparing [=================================&gt;                 ]</div><div>^COperation continuing in background.</div><div>Use `docker service ps p1evkio5gq1apjn0iywno7drb` to check progress.</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name db --network backend -e POSTGRES_PASSWORD=mypass --mount type=volume,source=db-data,target=/var/lib/postgresql/data postgres:9.4</span></div><div>tihtgcdh6gshc0o29knlicfb6</div><div>overall progress: 0 out of 1 tasks</div><div>1/1: preparing [=================================&gt;                 ]</div><div>^COperation continuing in background.</div><div>Use `docker service ps tihtgcdh6gshc0o29knlicfb6` to check progress.</div><div><br/></div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name result --network backend  -p 5001:80 dockersamples/examplevotingapp_result:before</span></div><div>kx97ihdnyo5g6rg8zmwfiedts</div><div>overall progress: 1 out of 1 tasks</div><div>1/1: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service ls</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ID                  NAME                MODE                REPLICAS            IMAGE                                          PORTS</div><div>tihtgcdh6gsh        db                  replicated          1/1                 postgres:9.4</div><div>m1p0xjgxjssp        redis               replicated          1/1                 redis:3.2</div><div>kx97ihdnyo5g        result              replicated          1/1                 dockersamples/examplevotingapp_result:before   *:5001-&gt;80/tcp</div><div>80cp2ce2p5xo        search              replicated          3/3                 elasticsearch:2                                *:9200-&gt;9200/tcp</div><div>nixnml5rtecs        vote                replicated          2/2                 dockersamples/examplevotingapp_vote:before     *:80-&gt;80/tcp</div><div>p1evkio5gq1a        worker              replicated          1/1                 dockersamples/examplevotingapp_worker:latest</div></div><div><br/></div><div><span style="font-size: 14pt; font-weight: bold;">Как решил задачу препод:</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>docker network create -d overlay backend</div><div>docker network create -d overlay frontend</div><div>docker service create --name vote -p 80:80 --network frontend --replicas 2 dockersamples/examplevotingapp_vote:before</div><div>docker service create --name redis --network frontend --replicas 1 redis:3.2</div><div>docker service create --name worker --network frontend --network backend dockersamples/examplevotingapp_worker</div><div>docker service create --name db --network backend --mount type=volume,source=db-data,target=/var/lib/postgresql/data postgres:9.4</div><div>docker service create --name result --network backend  -p 5001:80 dockersamples/examplevotingapp_result:before</div></div><div><br/></div><div>Почему у меня была проблемы с подсчетом голосов в приложении?:</div><div>Потому что запустил базу с параметром <span style="font-weight: bold;">-e POSTGRES_PASSWORD=mypass</span></div><div><span style="font-weight: bold;">В результате воркер не смог к ней подключиться.</span></div><div><span style="font-weight: bold;">К редис могу, а к базе нет.</span></div><div><span style="font-weight: bold;">А должен был быть такой лог после запуска сервиса базы:</span></div><div>docker service logs db</div><div>db.1.lnuupgmbrp1w@node2    | WARNING: No password has been set for the database.</div><div>db.1.lnuupgmbrp1w@node2    |          This will allow anyone with access to the</div><div>db.1.lnuupgmbrp1w@node2    |          Postgres port to access your database. In</div><div>db.1.lnuupgmbrp1w@node2    |          Docker's default configuration, this is</div><div>db.1.lnuupgmbrp1w@node2    |          effectively any other container on the same</div><div>db.1.lnuupgmbrp1w@node2    |          system.</div><div>db.1.lnuupgmbrp1w@node2    |</div><div>db.1.lnuupgmbrp1w@node2    |          Use &quot;-e POSTGRES_PASSWORD=password&quot; to set</div><div>db.1.lnuupgmbrp1w@node2    |          it in &quot;docker run&quot;.</div><div>db.1.lnuupgmbrp1w@node2    | ****************************************************</div><div><br/></div><div><span style="font-weight: bold;">При нажатии на голосование на веб-странице появляюся такие записи:</span></div><div>db.1.lnuupgmbrp1w@node2    | STATEMENT:  SELECT vote, COUNT(id) AS count FROM votes GROUP BY vote</div><div>db.1.lnuupgmbrp1w@node2    | ERROR:  duplicate key value violates unique constraint &quot;votes_id_key&quot;</div><div>db.1.lnuupgmbrp1w@node2    | DETAIL:  Key (id)=(4a44aea0dcd601d7) already exists.</div><div>db.1.lnuupgmbrp1w@node2    | STATEMENT:  INSERT INTO votes (id, vote) VALUES ($1, $2)</div><div><br/></div><div><span style="font-weight: bold;">Проблему решил пересозданием сервиса базы:</span></div><div><span style="font-weight: bold;">docker service rm db</span></div><div>docker service create --name db --network backend --mount type=volume,source=db-data2,target=/var/lib/postgresql/data postgres:9.4</div><div><br/></div><div>По своим логам я вижу, что не все хорошо:</div><div>root@node1:~# docker service logs result</div><div>result.1.cvg1uv2l0kdp@node2    | Waiting for db</div><div>result.1.cvg1uv2l0kdp@node2    | Waiting for db</div><div><br/></div><div>и</div><div><br/></div><div>root@node1:~# <span style="font-weight: bold;">docker service logs db</span></div><div>db.1.18e2iutnmbsd@node3    | FATAL:  password authentication failed for user &quot;postgres&quot;</div><div>db.1.18e2iutnmbsd@node3    | DETAIL:  Connection matched pg_hba.conf line 95: &quot;host all all all md5&quot;</div><div><br/></div><div>и docker service ps ... [по сервисам] покаывает, что не все хорошо:</div><div>Shutdown            </div><div><br/></div><div>Удаляю сервис базы:</div><div>root@node1:~# <span style="font-weight: bold;">docker service rm db</span></div><div><br/></div><div>И пересоздаю без переменной пароля на пользователя базы:</div><div>root@node1:~# <span style="font-weight: bold;">docker service create --name db --network backend --mount type=volume,source=db-data,target=/var/lib/postgresql/data postgres:9.4</span></div><div><br/></div><div>Хорошо:</div><div>root@node1:~# <span style="font-weight: bold;">docker service ps db</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS</div><div>mk18na126gqj        db.1                postgres:9.4        node3               Running             Running 4 minutes ago</div><div><br/></div><div>И просто отлично:</div><div>root@node1:~# <span style="font-weight: bold;">docker service ps result</span></div><div>ID                  NAME                IMAGE                                          NODE                DESIRED STATE       CURRENT STATE            ERROR                       PORTS</div><div>g8tg83wzipki        result.1            dockersamples/examplevotingapp_result:before   node2               Running             Running 33 seconds ago</div><div>93r6vdgq7xs5         \_ result.1        dockersamples/examplevotingapp_result:before   node2               Shutdown            Failed 39 seconds ago    &quot;task: non-zero exit (1)&quot;</div><div>cvg1uv2l0kdp         \_ result.1        dockersamples/examplevotingapp_result:before   node2               Shutdown            Failed 17 minutes ago    &quot;task: non-zero exit (1)&quot;</div><div><br/></div><div>Проверяем приложение.</div><div>Смотрю адрес своего дроплета DigitalOcean:</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [16].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>Захоже на адрес и вижу, что приложение работает:</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [17].png" type="image/png" data-filename="Image.png"/></div><div>Даже показывается ниже айди контейнера:</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [18].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>А по этому адресу - что подсчет работает - т.е. вся цепочка отрабатывает как надо:</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [20].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">Stacks:</span></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [21].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>vim example-voting-app-stack.yml</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>version: &quot;3&quot;</div><div>services:</div><div><br/></div><div>  redis:</div><div>    image: redis:alpine</div><div>    ports:</div><div>      - &quot;6379&quot;</div><div>    networks:</div><div>      - frontend</div><div>    deploy:</div><div>      replicas: 1</div><div>      update_config:</div><div>        parallelism: 2</div><div>        delay: 10s</div><div>      restart_policy:</div><div>        condition: on-failure</div><div>  db:</div><div>    image: postgres:9.4</div><div>    volumes:</div><div>      - db-data:/var/lib/postgresql/data</div><div>    networks:</div><div>      - backend</div><div>    deploy:</div><div>      placement:</div><div>        constraints: [node.role == manager]</div><div>  vote:</div><div>    image: dockersamples/examplevotingapp_vote:before</div><div>    ports:</div><div>      - 5000:80</div><div>    networks:</div><div>      - frontend</div><div>    depends_on:</div><div>      - redis</div><div>    deploy:</div><div>      replicas: 2</div><div>      update_config:</div><div>        parallelism: 2</div><div>      restart_policy:</div><div>        condition: on-failure</div><div>  result:</div><div>    image: dockersamples/examplevotingapp_result:before</div><div>    ports:</div><div>      - 5001:80</div><div>    networks:</div><div>      - backend</div><div>    depends_on:</div><div>      - db</div><div>    deploy:</div><div>      replicas: 1</div><div>      update_config:</div><div>        parallelism: 2</div><div>        delay: 10s</div><div>      restart_policy:</div><div>        condition: on-failure</div><div><br/></div><div>  worker:</div><div>    image: dockersamples/examplevotingapp_worker</div><div>    networks:</div><div>      - frontend</div><div>      - backend</div><div>    deploy:</div><div>      mode: replicated</div><div>      replicas: 1</div><div>      labels: [APP=VOTING]</div><div>      restart_policy:</div><div>        condition: on-failure</div><div>        delay: 10s</div><div>        max_attempts: 3</div><div>        window: 120s</div><div>      placement:</div><div>        constraints: [node.role == manager]</div><div><br/></div><div>  visualizer:</div><div>    image: dockersamples/visualizer</div><div>    ports:</div><div>      - &quot;8080:8080&quot;</div><div>    stop_grace_period: 1m30s</div><div>    volumes:</div><div>      - &quot;/var/run/docker.sock:/var/run/docker.sock&quot;</div><div>    deploy:</div><div>      placement:</div><div>        constraints: [node.role == manager]</div><div><br/></div><div>networks:</div><div>  frontend:</div><div>  backend:</div><div><br/></div><div>volumes:</div><div>  db-data:</div></div><div>sd</div><div><br/></div><div><br/></div><div>root@node1:~/docker# git clone <a href="https://github.com/BretFisher/udemy-docker-mastery.git">https://github.com/BretFisher/udemy-docker-mastery.git</a> udemy-docker-mastery</div><div>Cloning into 'udemy-docker-mastery'...</div><div>remote: Enumerating objects: 712, done.</div><div>remote: Total 712 (delta 0), reused 0 (delta 0), pack-reused 712</div><div>Receiving objects: 100% (712/712), 4.57 MiB | 1.60 MiB/s, done.</div><div>Resolving deltas: 100% (287/287), done.</div><div>root@node1:~/docker# ls</div><div>udemy-docker-mastery</div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [22].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# cat psql_user.txt</div><div>mypsqluser</div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# docker secret</div><div>create   inspect  ls       rm</div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# docker secret create psql_user psql_user.txt</div><div>tuhws6o0j4ed72o7f5qpi78fg</div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# echo &quot;myDBpassWORD&quot; | docker secret create psql_pass -</div><div>fghxxvxofzjajjft1o485x3e6</div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# docker secret ls</div><div>ID                          NAME                DRIVER              CREATED              UPDATED</div><div>fghxxvxofzjajjft1o485x3e6   psql_pass                               6 seconds ago        6 seconds ago</div><div>tuhws6o0j4ed72o7f5qpi78fg   psql_user                               About a minute ago   About a minute ago</div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# <span style="font-weight: bold;">docker secret inspect psql_user</span></div><div>[</div><div>    {</div><div>        &quot;ID&quot;: &quot;tuhws6o0j4ed72o7f5qpi78fg&quot;,</div><div>        &quot;Version&quot;: {</div><div>            &quot;Index&quot;: 848</div><div>        },</div><div>        &quot;CreatedAt&quot;: &quot;2018-11-12T17:54:49.586980127Z&quot;,</div><div>        &quot;UpdatedAt&quot;: &quot;2018-11-12T17:54:49.586980127Z&quot;,</div><div>        &quot;Spec&quot;: {</div><div>            &quot;Name&quot;: &quot;psql_user&quot;,</div><div>            &quot;Labels&quot;: {}</div><div>        }</div><div>    }</div><div>]</div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# <span style="font-weight: bold;">docker secret inspect psql_pass</span></div><div>[</div><div>    {</div><div>        &quot;ID&quot;: &quot;fghxxvxofzjajjft1o485x3e6&quot;,</div><div>        &quot;Version&quot;: {</div><div>            &quot;Index&quot;: 849</div><div>        },</div><div>        &quot;CreatedAt&quot;: &quot;2018-11-12T17:55:43.51762921Z&quot;,</div><div>        &quot;UpdatedAt&quot;: &quot;2018-11-12T17:55:43.51762921Z&quot;,</div><div>        &quot;Spec&quot;: {</div><div>            &quot;Name&quot;: &quot;psql_pass&quot;,</div><div>            &quot;Labels&quot;: {}</div><div>        }</div><div>    }</div><div>]</div><div><br/></div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/secrets-sample-1# docker service create --secret psql_user --secret psql_pass -e POSTGRES_PASSWO             RD_FILE=/run/secrets/psql_pass -e POSTGRES_USER_FILE=/run/secrets/psql_user postgres</div><div>c0lcrnvkm0jk2dpjh66foxgoc</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker container ls</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>CONTAINER ID        IMAGE                                          COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div>2d80d9ac2632        postgres:latest                                &quot;docker-entrypoint.s…&quot;   16 minutes ago      Up 16 minutes       5432/tcp            vigilant_feynman.1.1uqwlarj285cypw2ycr44qc87</div><div>6f9468e86a4e        dockersamples/examplevotingapp_vote:before     &quot;gunicorn app:app -b…&quot;   About an hour ago   Up About an hour    80/tcp              voteapp_vote.5.fz21e1pk3dnrbov55ksp7onvn</div><div>c3137fa6d80d        dockersamples/examplevotingapp_worker:latest   &quot;/bin/sh -c 'dotnet …&quot;   About an hour ago   Up About an hour                        voteapp_worker.1.bhpf0vkd15bsrzpe72sxaxeb6</div><div>0a707798c599        dockersamples/examplevotingapp_vote:before     &quot;gunicorn app:app -b…&quot;   About an hour ago   Up About an hour    80/tcp              voteapp_vote.1.3vtiqucao77umjotq42hhno2d</div></div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker container exec -it 2d80d9ac2632 bash</span></div><div><br/></div><div>root@2d80d9ac2632:/# <span style="font-weight: bold;">ls -al /run/secrets/</span></div><div>total 20</div><div>drwxr-xr-x 2 root root 4096 Nov 12 18:16 .</div><div>drwxr-xr-x 1 root root 4096 Nov 12 18:16 ..</div><div>-r--r--r-- 1 root root   13 Nov 12 18:16 psql_pass</div><div>-r--r--r-- 1 root root   11 Nov 12 18:16 psql_user</div><div><br/></div><div>root@2d80d9ac2632:/# <span style="font-weight: bold;">cat /run/secrets/psql_pass</span></div><div>myDBpassWORD</div><div>root@2d80d9ac2632:/# <span style="font-weight: bold;">cat /run/secrets/psql_user</span></div><div>mypsqluser</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                 MODE                REPLICAS            IMAGE                                          PORTS</div><div>c0lcrnvkm0jk        <span style="font-weight: bold;">vigilant_feynman     </span>replicated          1/1                 postgres:latest</div><div>ncm9fqejw3pu        voteapp_db           replicated          1/1                 postgres:9.4</div><div>l5tlbekch9qg        voteapp_redis        replicated          1/1                 redis:alpine                                   *:30000-&gt;6379/tcp</div><div>znggu8gvq0wx        voteapp_result       replicated          1/1                 dockersamples/examplevotingapp_result:before   *:5001-&gt;80/tcp</div><div>vuavrtckdtb4        voteapp_visualizer   replicated          1/1                 dockersamples/visualizer:latest                *:8080-&gt;8080/tcp</div><div>9n0bhum0kh7i        voteapp_vote         replicated          5/5                 dockersamples/examplevotingapp_vote:before     *:5000-&gt;80/tcp</div><div>03ew1r56sc7k        voteapp_worker       replicated          1/1                 dockersamples/examplevotingapp_worker:latest</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker service ps vigilant_feynman</span></div><div>ID                  NAME                 IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</div><div>1uqwlarj285c        vigilant_feynman.1   postgres:latest     node3               Running             Running 26 minutes ago</div><div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [23].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><a href="https://docs.docker.com/engine/swarm/secrets/#use-secrets-in-compose">https://docs.docker.com/engine/swarm/secrets/#use-secrets-in-compose</a></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>version: '3.1'</div><div><br/></div><div>services:</div><div><br/></div><div>  drupal:</div><div>    image: drupal:8.2</div><div>    ports:</div><div>      - &quot;8082:80&quot;</div><div>    volumes:</div><div>      - drupal-modules:/var/www/html/modules</div><div>      - drupal-profiles:/var/www/html/profiles</div><div>      - drupal-sites:/var/www/html/themes</div><div>      - drupal-themes:/var/www/html/sites</div><div><br/></div><div>  postgres:</div><div>    image: postgres:9.6</div><div>    environment:</div><div>      - POSTGRES_PASSWORD_FILE=/run/secrets/psql_pw</div><div>    secrets:</div><div>      - psql_pw</div><div>    volumes:</div><div>      - drupal-data:/var/lib/postgresql/data</div><div><br/></div><div><br/></div><div>volumes:</div><div>   drupal-data:</div><div>   drupal-modules:</div><div>   drupal-profiles:</div><div>   drupal-sites:</div><div>   drupal-themes:</div><div><br/></div><div>secrets:</div><div>  psql_pw:</div><div>    external: true</div></div><div><br/></div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/compose-assignment-2# <span style="font-weight: bold;">echo &quot;oafy938hs&quot; | docker secret create psql_pw -</span></div><div>nqt28ux14zted2rqp9sdij4n8</div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/compose-assignment-2# <span style="font-weight: bold;">docker stack deploy -c docker-compose-stack-secrets.yml drupal</span></div><div>Creating service drupal_drupal</div><div>Creating service drupal_postgres</div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/compose-assignment-2# <span style="font-weight: bold;">docker stack ps drupal</span></div><div>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS</div><div>xzld8s9dedf4        drupal_postgres.1   postgres:9.6        node1               Running             Running 7 minutes ago</div><div>3lqyf3v5zzx0        drupal_drupal.1     drupal:8.2          node3               Running             Running 3 minutes ago</div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/compose-assignment-2# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                  MODE                REPLICAS            IMAGE                                          PORTS</div><div>nmaxloll47rg        drupal_drupal         replicated          0/1                 drupal:8.2                                     *:8082-&gt;80/tcp</div><div>mxiu0apkxn22        drupal_postgres       replicated          1/1                 postgres:9.6</div><div><br/></div><div><br/></div><div>Если нода в сварме, а нам нужно покинуть сварм, то:</div><div><a href="https://docs.docker.com/engine/reference/commandline/swarm_leave/#parent-command">https://docs.docker.com/engine/reference/commandline/swarm_leave/#parent-command</a></div><div><br/></div><div>before:</div><div>vdanev@ora-vsrv:~$ <span style="font-weight: bold;">docker node ls</span></div><div>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</div><div>ir11u2te4n8fjqrw0s9s5q5o0 *   ora-vsrv            Ready               Active              Leader              18.06.1-ce</div><div><br/></div><div>vdanev@ora-vsrv:~$ <span style="font-weight: bold;">docker swarm leave</span></div><div>Error response from daemon: You are attempting to leave the swarm on a node that is participating as a manager. Removing the last manager erases all current state of the swarm. Use `--force` to ignore this message.</div><div>vdanev@ora-vsrv:~$ <span style="font-weight: bold;">docker swarm leave --force</span></div><div>Node left the swarm.</div><div><br/></div><div>after:</div><div>vdanev@ora-vsrv:~$ <span style="font-weight: bold;">docker node ls</span></div><div>Error response from daemon: This node is not a swarm manager. Use &quot;docker swarm init&quot; or &quot;docker swarm join&quot; to connect this node to swarm and try again.</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Runs first the docker-compose.yml, than docker-compose.override.yml:</span></div><div>vdanev@ora-vsrv:~/docker/udemy-docker-mastery/secrets-sample-2$ <span style="font-weight: bold;">docker-compose up -d</span></div><div>Creating network &quot;secrets-sample-2_default&quot; with the default driver</div><div>Creating secrets-sample-2_psql_1_934f434d86bc ... done</div><div><br/></div><div><br/></div><div>root@node1:~/docker/udemy-docker-mastery/swarm-stack-3# <span style="font-weight: bold;">ls -lrt</span></div><div>total 32</div><div>-rw-r--r--  1 root root    9 Nov 12 17:14 psql-fake-password.txt</div><div>-rw-r--r--  1 root root  106 Nov 12 17:14 docker-compose.yml</div><div>-rw-r--r--  1 root root  326 Nov 12 17:14 docker-compose.test.yml</div><div>-rw-r--r--  1 root root  558 Nov 12 17:14 docker-compose.prod.yml</div><div>-rw-r--r--  1 root root  582 Nov 12 17:14 docker-compose.override.yml</div><div>-rw-r--r--  1 root root  518 Nov 12 17:14 Dockerfile</div><div>drwxr-xr-x  2 root root 4096 Nov 12 17:14 themes</div><div>drwxr-xr-x 10 root root 4096 Nov 12 17:14 sample-data</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Make merged from 2 file config file:</span></div><div>root@node1:~/docker/udemy-docker-mastery/swarm-stack-3# docker-compose -f docker-compose.yml -f docker-compose.prod.yml config</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>secrets:</div><div>  psql-pw:</div><div>    external: true</div><div>services:</div><div>  drupal:</div><div>    image: custom-drupal:latest</div><div>    ports:</div><div>    - 80:80/tcp</div><div>    volumes:</div><div>    - drupal-modules:/var/www/html/modules:rw</div><div>    - drupal-profiles:/var/www/html/profiles:rw</div><div>    - drupal-sites:/var/www/html/sites:rw</div><div>    - drupal-themes:/var/www/html/themes:rw</div><div>  postgres:</div><div>    environment:</div><div>      POSTGRES_PASSWORD_FILE: /run/secrets/psql-pw</div><div>    image: postgres:9.6</div><div>    secrets:</div><div>    - source: psql-pw</div><div>    volumes:</div><div>    - drupal-data:/var/lib/postgresql/data:rw</div><div>version: '3.1'</div><div>volumes:</div><div>  drupal-data: {}</div><div>  drupal-modules: {}</div><div>  drupal-profiles: {}</div><div>  drupal-sites: {}</div><div>  drupal-themes: {}</div></div><div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [24].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>2</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [25].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>3</div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [26].png" type="image/png" data-filename="Image.png"/></div><div style="min-height: 12pt; text-align: left;"><span style="min-height: 12pt; font-size: 10pt; color: rgb(1, 1, 1); font-family: TrebuchetMS;">docker service create -p 8088:80 --name web nginx:1.13.7</span></div><div style="min-height: 12pt; text-align: left;"><span style="min-height: 12pt; font-size: 10pt; color: rgb(1, 1, 1); font-family: TrebuchetMS;">docker service scale web=5</span></div><div style="min-height: 12pt; text-align: left;"><span style="min-height: 12pt; font-size: 10pt; color: rgb(1, 1, 1); font-family: TrebuchetMS;">docker service update --image nginx:1.13.6 web</span></div><div style="min-height: 12pt; text-align: left;"><span style="min-height: 12pt; font-size: 10pt; color: rgb(1, 1, 1); font-family: TrebuchetMS;">docker service update --publish-rm 8088 --publish-add 9090:80 web</span></div><div style="min-height: 12pt; text-align: left;"><span style="min-height: 12pt; font-size: 10pt; color: rgb(1, 1, 1); font-family: TrebuchetMS;">docker service update --force web</span></div><div style="min-height: 12pt; text-align: left;"></div><div><br/></div><div><span style="font-weight: bold;">Создаем сервис с указанием точной версии образа, как мы всегда и должны делать в проде:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service create -p 8088:80 --name web nginx:1.13.7</span></div><div>6qxf2pwppq1ruzi6q9qnhs8m0</div><div><br/></div><div><span style="font-weight: bold;">Сервис создался с 1 репликой:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                  MODE                REPLICAS            IMAGE               PORTS</div><div>6qxf2pwppq1r        web                   replicated          0/1                 nginx:1.13.7        *:8088-&gt;80/tcp</div><div><br/></div><div>Расширяем реплику до 5:</div><div>root@node3:~# <span style="font-weight: bold;">docker service scale web=5</span></div><div>web scaled to 5</div><div>overall progress: 0 out of 5 tasks</div><div>overall progress: 3 out of 5 tasks</div><div>1/5: preparing [=================================&gt;                 ]</div><div>2/5: running   [==================================================&gt;]</div><div>3/5: preparing [=================================&gt;                 ]</div><div>4/5: running   [==================================================&gt;]</div><div>5/5: running   [==================================================&gt;]</div><div><br/></div><div><span style="font-weight: bold;">Сервис расширился и 3 из 5 реплик уже поднялись:</span></div><div>root@node3:~# docker service ls</div><div>ID                  NAME                  MODE                REPLICAS            IMAGE               PORTS</div><div>6qxf2pwppq1r        web                   replicated          3/5                 nginx:1.13.7        *:8088-&gt;80/tcp</div><div><br/></div><div><span style="font-weight: bold;">Меняем версию имейджа:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service update --image nginx:1.13.6 web</span></div><div><span style="font-weight: bold;">web</span></div><div>overall progress: 5 out of 5 tasks</div><div>1/5: running   [==================================================&gt;]</div><div>2/5: running   [==================================================&gt;]</div><div>3/5: running   [==================================================&gt;]</div><div>4/5: running   [==================================================&gt;]</div><div>5/5: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div><span style="font-weight: bold;">Версия имейджа поменялась:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                  MODE                REPLICAS            IMAGE               PORTS</div><div>6qxf2pwppq1r        web                   replicated          5/5                 nginx:<span style="font-weight: bold;">1.13.6 </span>       *:8088-&gt;80/tcp</div><div><br/></div><div><span style="font-weight: bold;">Меняем паблишед порты на запущенном сервисе:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service update \</span></div><div><span style="font-weight: bold;">--publish-rm 8088:80 \</span></div><div><span style="font-weight: bold;">--publish-add 9090:80 \</span></div><div><span style="font-weight: bold;">web</span></div><div><br/></div><div>overall progress: 5 out of 5 tasks</div><div>1/5: running   [==================================================&gt;]</div><div>2/5: running   [==================================================&gt;]</div><div>3/5: running   [==================================================&gt;]</div><div>4/5: running   [==================================================&gt;]</div><div>5/5: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div><span style="font-weight: bold;">Порты изменились:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service ls</span></div><div>ID                  NAME                  MODE                REPLICAS            IMAGE               PORTS</div><div>6qxf2pwppq1r        web                   replicated          5/5                 nginx:1.13.6        *:9090-&gt;80/tcp</div><div><br/></div><div>командой:</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>docker service update \</div><div>--publish-rm 8088:80 \</div><div>--publish-add 9090:80 \</div><div>  web</div></div><div><br/></div><div><span style="font-weight: bold;">Способ rebalancing сервиса, когда изменяется кол-во хостов или что-то еще с ресурсами - такой трюк помогает сделать рибалансировку сервиса:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service update --force web</span></div><div>web</div><div>overall progress: 5 out of 5 tasks</div><div>1/5: running   [==================================================&gt;]</div><div>2/5: running   [==================================================&gt;]</div><div>3/5: running   [==================================================&gt;]</div><div>4/5: running   [==================================================&gt;]</div><div>5/5: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div><span style="font-weight: bold;">Чистим после себя:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service rm web</span></div><div>web</div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [27].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [28].png" type="image/png" data-filename="Image.png"/></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">Start a postgres container</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker container run --name p1 -d postgres</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">Then start one with healthcheck</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker container run --name p2 -d --health-cmd=&quot;pg_isready -U postgres || exit 1&quot; postgres</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker container ls</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker container inspect p2</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker service create --name p1 postgres</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">docker service create --name p2 --health-cmd=&quot;pg_isready -U postgres || exit 1&quot; postgres</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">preparing</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">starting</span></span></div><div style="min-height: 17pt; text-align: left;"><span style="min-height: 17pt;"><span style="font-size: 12pt; color: rgb(1, 1, 1); font-family: Arial;">running</span></span></div><div style="min-height: 17pt; text-align: left;"></div><div><br/></div><div><span style="font-weight: bold;">Стартуем контейнер без проверок:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker container run --name p1 -d postgres</span></div><div>Unable to find image 'postgres:latest' locally</div><div>latest: Pulling from library/postgres</div><div>Digest: sha256:e6708d2202efbeada699821bafb710365d6d13d61ab5d838a015d3acd08d6f7e</div><div>Status: Downloaded newer image for postgres:latest</div><div>688aef0b0ee7b096dbbc9d175b356bcd11d3e5cafa688c763d9fac08a7c60cf8</div><div><br/></div><div>root@node3:~# <span style="font-weight: bold;">docker container ls</span></div><div>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div>688aef0b0ee7        postgres            &quot;docker-entrypoint.s…&quot;   14 seconds ago      Up 13 seconds       5432/tcp            p1</div><div><br/></div><div><span style="font-weight: bold;">Стартуем контейнер с проверкой:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker container run --name p2 -d --health-cmd=&quot;pg_isready -U postgres || exit 1&quot; postgres</span></div><div>10b6b30e896b0bac0f302a28fb66ec68ab512749c0a64a5ae81612e4856897f9</div><div><br/></div><div>До 30 секунд будет в режиме стартинг - <span style="font-weight: bold;">health: starting:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker container ls</span></div><div>CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                             PORTS               NAMES</div><div>10b6b30e896b        postgres            &quot;docker-entrypoint.s…&quot;   12 seconds ago       Up 11 seconds (<span style="font-weight: bold;">health: starting</span>)   5432/tcp            p2</div><div>688aef0b0ee7        postgres            &quot;docker-entrypoint.s…&quot;   About a minute ago   Up About a minute                  5432/tcp            p1</div><div><br/></div><div><span style="font-weight: bold;">Потом статус изменится на здоровый:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker container ls</span></div><div>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                   PORTS               NAMES</div><div>10b6b30e896b        postgres            &quot;docker-entrypoint.s…&quot;   2 minutes ago       Up 2 minutes (<span style="font-weight: bold;">healthy</span>)   5432/tcp            p2</div><div>688aef0b0ee7        postgres            &quot;docker-entrypoint.s…&quot;   4 minutes ago       Up 4 minutes             5432/tcp            p1</div><div><br/></div><div><span style="font-weight: bold;">Пройденные проверки можно увидеть так:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker container inspect p2</span></div><div><span style="font-weight: bold;">...</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&quot;Health&quot;: {</div><div>                &quot;Status&quot;: &quot;healthy&quot;,</div><div>                &quot;FailingStreak&quot;: 0,</div><div>                &quot;Log&quot;: [</div><div>                    {</div><div>                        &quot;Start&quot;: &quot;2018-11-14T20:03:57.534832551Z&quot;,</div><div>                        &quot;End&quot;: &quot;2018-11-14T20:03:57.655319637Z&quot;,</div><div>                        &quot;ExitCode&quot;: 0,</div><div>                        &quot;Output&quot;: &quot;/var/run/postgresql:5432 - accepting connections\n&quot;</div><div>                    },</div><div>                    {</div><div>                        &quot;Start&quot;: &quot;2018-11-14T20:04:27.664516457Z&quot;,</div><div>                        &quot;End&quot;: &quot;2018-11-14T20:04:27.793840623Z&quot;,</div><div>                        &quot;ExitCode&quot;: 0,</div><div>                        &quot;Output&quot;: &quot;/var/run/postgresql:5432 - accepting connections\n&quot;</div><div>                    },</div><div>         ...</div><div>                    }</div><div>                ]</div><div>            }</div></div><div><br/></div><div><span style="font-weight: bold;">Теперь то же самое, но как с сервисом.</span></div><div><span style="font-weight: bold;">При старте докер ожидает 30 секунд до первого хелсчека.</span></div><div><span style="font-weight: bold;"> По истечении этого времени из стартед становится раннед:</span></div><div>root@node3:~# <span style="font-weight: bold;">docker service create --name p2 --health-cmd=&quot;pg_isready -U postgres || exit 1&quot; postgres</span></div><div>g96oxpjqiunw2lcgh4ocujf2d</div><div>overall progress: 1 out of 1 tasks</div><div>1/1: running   [==================================================&gt;]</div><div>verify: Service converged</div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [29].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><a href="https://github.com/docker/distribution">https://github.com/docker/distribution</a></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [30].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [31].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [32].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>Empty repository:</div><div><a href="http://ip172-18-0-70-bfn647k9cs9g00f9uk30-5000.direct.labs.play-with-docker.com/v2/_catalog">http://ip172-18-0-70-bfn647k9cs9g00f9uk30-5000.direct.labs.play-with-docker.com/v2/_catalog</a></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [33].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-weight: bold;">Pushed image to the local repo:</span></div><div>docker-push 127.0.0.1:5000/hello-world</div><div><a href="http://ip172-18-0-70-bfn647k9cs9g00f9uk30-5000.direct.labs.play-with-docker.com/v2/_catalog">http://ip172-18-0-70-bfn647k9cs9g00f9uk30-5000.direct.labs.play-with-docker.com/v2/_catalog</a></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [34].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>docker pull nginx</div><div>docker tag nginx 127.0.0.1:5000/nginx</div><div>docker push 127.0.0.1:5000/nginx</div><div><br/></div><div><span style="font-weight: bold;">now, two:</span></div><div><img src="Docker_Mastery_course-2._with_hometasks.enex_files/Image [35].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>docker service create --name nginx -p 80:80 --replicas 5 --detach=false 127.0.0.1:5000/nginx</div></span>
</div></body></html> 